<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo Taruga</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#8aa0c8; --border:#22314f; --accent:#4cc9f0; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Ubuntu,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:26px 16px 18px;text-align:center;border-bottom:1px solid var(--border)}
    header h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px}
    main{max-width:1200px;margin:0 auto;padding:18px}
    .toolbar{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    select{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .view{min-height:200px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.18);margin-bottom:16px}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card h2{margin:0;font-size:18px}
    .card small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:center}
    th{position:sticky;top:0;background:#0e172a;font-weight:700}
    tr:nth-child(even) td{background:#0f1a31}
    .two-col{display:grid;grid-template-columns:2fr 1.2fr;gap:12px;padding:12px}
    .panel{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .panel header{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .panel .body{padding:8px 12px}
    .warn{padding:12px 16px;color:#ffd7d7}
    .score{font-weight:800;border-left:3px solid #22314f}

    .reg-title{font-size:22px;font-weight:900;text-align:center;margin:6px 0 10px}
    .reg-sec-title{font-size:18px;font-weight:800;margin:12px 0 6px;text-align:center}
    .reg-row{display:grid;grid-template-columns:140px 1fr;gap:12px;padding:6px 0}
    .reg-row .idx{font-weight:700}
    .wrap{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere;line-height:1.45}
    .italic{font-style:italic}
    .bold{font-weight:800}

    /* Iconos podio */
    .podio-icon{ width:28px; height:28px; object-fit:contain; display:inline-block }
  </style>
</head>
<body>
  <header>
    <h1>Torneo Taruga</h1>
    <div class="toolbar">
      <button id="btnReglamento" class="btn">Reglamento</button>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTorneo" class="btn">Torneo</button>
        <select id="selTorneo" aria-label="Seleccionar torneo">
          <option value="apertura">Apertura 2025</option>
          <option value="clausura">Clausura 2025</option>
        </select>
      </div>
      <button id="btnActualizar" class="btn">Actualizar</button>
    </div>
  </header>
  <main>
    <section id="view" class="view"></section>
    <p style="text-align:center;color:var(--muted)"> Â© 2025. Oriente Sur â€¢ Todos los derechos reservados</p>
  </main>

  <script>
    // =============================
    // CONFIG
    // =============================
    const SHEET_ID = "1_fruD9zPdXhiWcP_wuuryIFHmxLQBlYHDM9CyY0_1s4";

    const CFG = {
      reglamento: { gid: "406827875" },
      apertura:   { gid: "888277887", range: { startCol:0, endCol:9,  startRow:0, endRow:null } },
      clausura:   { gid: "62379087",  range: { startCol:0, endCol:10, startRow:0, endRow:null } }
    };

    // GIFs de podio
    const PODIO_GIFS = {
      "1": { src: "https://drive.google.com/uc?export=view&id=1HXN4Qw72s0hnweKJhfSAjZMolZ_8DvsV", title: "ðŸ¥‡ CampeÃ³n anterior" },
      "2": { src: "https://drive.google.com/uc?export=view&id=1GdwLSU2qeOpA664r2fb1UUypmXfKPF3v", title: "ðŸ¥ˆ SubcampeÃ³n anterior" },
      "3": { src: "https://drive.google.com/uc?export=view&id=11296-D02uSO3SZpZOlNa5lKpOyJobe0T", title: "ðŸ¥‰ Tercer puesto anterior" }
    };

    // =============================
    // Helpers
    // =============================
    const view = document.getElementById('view');
    const btnReglamento = document.getElementById('btnReglamento');
    const btnTorneo = document.getElementById('btnTorneo');
    const btnActualizar = document.getElementById('btnActualizar');
    const selTorneo = document.getElementById('selTorneo');

    function gvizUrl(gid, rangeA1){
      const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
      const r = rangeA1 ? `&range=${encodeURIComponent(rangeA1)}&headers=0` : '';
      return `${base}${r}&cacheBust=${Date.now()}`;
    }

    async function fetchRange(gid, rangeA1){
      const res = await fetch(gvizUrl(gid, rangeA1));
      const txt = await res.text();
      return parseGviz(txt);
    }

    function parseGviz(text){
      const start = text.indexOf('{'); const end = text.lastIndexOf('}');
      const json = JSON.parse(text.slice(start, end + 1));
      const cols = (json.table?.cols || []).map(c => c.label || c.id || "");
      const rows = (json.table?.rows || []).map(r => (r.c || []).map(c => c ? (c.f ?? c.v ?? "") : ""));
      return { cols, rows };
    }

    function sliceRange(rows, {startCol=0,endCol=null,startRow=0,endRow=null}={}){
      const colCount = rows[0]?.length ?? 0;
      const rowCount = rows.length;
      const eCol = endCol == null ? (colCount ? colCount-1 : 0) : Math.min(endCol, Math.max(0,colCount-1));
      let eRow = rowCount-1;
      if (endRow != null) eRow = Math.min(endRow, Math.max(0,rowCount-1));
      else {
        for (let i=rowCount-1; i>=startRow; i--) {
          if ((rows[i]||[]).some(c => String(c).trim() !== '')) { eRow = i; break; }
        }
      }
      return rows.slice(startRow, eRow+1).map(r => r.slice(startCol, eCol+1));
    }

    function makeCard(title, subtitle){
      const card=document.createElement('article'); card.className='card';
      const head=document.createElement('header'); const h2=document.createElement('h2'); h2.textContent=title;
      const small=document.createElement('small'); small.textContent=subtitle||''; head.appendChild(h2); head.appendChild(small);
      card.appendChild(head); return card;
    }

    // Podio
    function applyPodioBadges(table, cols){
      const idxStar = cols.findIndex(h => (h||"").trim() === "*");
      const colIdx = idxStar >= 0 ? idxStar : 0;
      table.querySelectorAll('tbody tr').forEach(tr => {
        const td = tr.children[colIdx];
        if (!td) return;
        const val = (td.textContent || "").trim();
        const gif = PODIO_GIFS[val];
        if (gif){
          td.innerHTML = `<img class="podio-icon" src="${gif.src}" alt="Podio ${val}" title="${gif.title}">`;
        } else {
          td.textContent = "";
        }
      });
    }

    // =============================
    // Reglamento
    // =============================
    async function renderReglamento(){
      view.innerHTML='';
      const gid = CFG.reglamento.gid;
      const card = makeCard('Reglamento', `gid: ${gid}`);
      view.appendChild(card);
      try{
        const regl = await fetchRange(gid, 'B1:D500');
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(regl.rows, null, 2);
        card.appendChild(pre);
      }catch(err){
        const p=document.createElement('p'); p.className='warn';
        p.textContent = `No se pudo leer el reglamento: ${err.message}`;
        card.appendChild(p);
      }
    }

    // =============================
    // Torneo
    // =============================
    async function renderRanking(which){
      view.innerHTML='';
      const cfg = CFG[which];
      // ðŸ‘‡ ahora sin gid
      const card = makeCard(which==='apertura'?'Torneo Apertura 2025':'Torneo Clausura 2025', '');
      view.appendChild(card);
      try{
        const res = await fetch(gvizUrl(cfg.gid));
        const txt = await res.text();
        const data = parseGviz(txt);
        const rows = sliceRange(data.rows, cfg.range).filter(r => r.some(c => String(c).trim() !== ''));
        let cols = data.cols.slice(cfg.range.startCol, cfg.range.endCol + 1);

        const table=document.createElement('table');
        const thead=document.createElement('thead'); const trh=document.createElement('tr');
        cols.forEach(h=>{const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);});
        thead.appendChild(trh); table.appendChild(thead);

        const tbody=document.createElement('tbody');
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          cols.forEach((_,i)=>{ const td=document.createElement('td'); td.textContent = r[i] ?? ''; tr.appendChild(td); });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody); card.appendChild(table);

        // Podio badges
        applyPodioBadges(table, cols);

      }catch(err){
        const p=document.createElement('p'); p.className='warn'; p.textContent = `No se pudo leer el torneo: ${err.message}`; card.appendChild(p);
      }
    }

    // =============================
    // Events
    // =============================
    btnReglamento.addEventListener('click', () => renderReglamento());
    btnTorneo.addEventListener('click', () => renderRanking(selTorneo.value));
    selTorneo.addEventListener('change', () => renderRanking(selTorneo.value));
    btnActualizar.addEventListener('click', () => {
      const active = view.querySelector('.card h2')?.textContent || '';
      if (/Reglamento/.test(active)) renderReglamento();
      else renderRanking(selTorneo.value);
    });

    renderReglamento();
  </script>
</body>
</html>
