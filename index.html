<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo Taruga – GViz</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#8aa0c8; --border:#22314f; --accent:#4cc9f0; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Ubuntu,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:26px 16px 18px;text-align:center;border-bottom:1px solid var(--border)}
    header h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px}
    main{max-width:1200px;margin:0 auto;padding:18px}
    .toolbar{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    select{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .view{min-height:200px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.18);margin-bottom:16px}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card h2{margin:0;font-size:18px}
    .card small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:center}
    th{position:sticky;top:0;background:#0e172a;font-weight:700}
    tr:nth-child(even) td{background:#0f1a31}
    .two-col{display:grid;grid-template-columns:2fr 1.2fr;gap:12px;padding:12px}
    .panel{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .panel header{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .panel .body{padding:8px 12px}
    .badge{display:inline-block;background:#0e172a;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .warn{padding:12px 16px;color:#ffd7d7}
    .score{font-weight:800;border-left:3px solid #22314f}

    /* Reglamento */
    .reg-sec-title{font-size:18px;font-weight:800;margin:10px 0 4px;text-align:center}
    .reg-art{display:grid;grid-template-columns:140px 1fr;gap:10px;padding:6px 0}
    .reg-art .t{font-style:italic;text-align:center;line-height:1.45}
  </style>
</head>
<body>
  <header>
    <h1>Torneo Taruga</h1>
    <div class="toolbar">
      <button id="btnReglamento" class="btn">Reglamento</button>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTorneo" class="btn">Torneo</button>
        <select id="selTorneo" aria-label="Seleccionar torneo">
          <option value="apertura">Apertura 2025</option>
          <option value="clausura">Clausura 2025</option>
        </select>
      </div>
      <button id="btnActualizar" class="btn">Actualizar</button>
    </div>
  </header>
  <main>
    <section id="view" class="view"></section>
    <p style="text-align:center;color:var(--muted)">Hecho para Renzo • GitHub Pages</p>
  </main>

  <script>
    // =============================
    // CONFIG
    // =============================
    const SHEET_ID = "1_fruD9zPdXhiWcP_wuuryIFHmxLQBlYHDM9CyY0_1s4";

    const CFG = {
      reglamento: {
        gid: "406827875",
        left:  { startCol: 1, endCol: 10, startRow: 0, endRow: 500 }, // B..K, filas 1..500 (dinámico)
        right: { startCol: 12, endCol: 21, startRow: 0, endRow: 50 }  // M..V, filas 1..50
      },
      apertura: {
        gid: "888277887",
        // A..J (Score en J). Filas dinámicas.
        range: { startCol: 0, endCol: 9, startRow: 0, endRow: null }
      },
      clausura: {
        gid: "62379087",
        // A..K (Cambio Posición en K). Filas dinámicas.
        range: { startCol: 0, endCol: 10, startRow: 0, endRow: null }
      }
    };

    // =============================
    // Helpers
    // =============================
    const view = document.getElementById('view');
    const btnReglamento = document.getElementById('btnReglamento');
    const btnTorneo = document.getElementById('btnTorneo');
    const btnActualizar = document.getElementById('btnActualizar');
    const selTorneo = document.getElementById('selTorneo');

    function gvizUrl(gid){
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}&cacheBust=${Date.now()}`;
    }

    function parseGviz(text){
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) throw new Error('Respuesta GViz inválida');
      const json = JSON.parse(text.slice(start, end + 1));
      if (json.status && json.status !== 'ok') {
        const det = json.errors && json.errors[0] ? `${json.errors[0].message}: ${json.errors[0].detailed_message || ''}` : 'Error GViz';
        throw new Error(det);
      }
      const cols = (json.table?.cols || []).map(c => c.label || c.id || "");
      const rows = (json.table?.rows || []).map(r => (r.c || []).map(c => (c ? c.v : "")));
      return { cols, rows };
    }

    function sliceRange(rows, {startCol=0,endCol=null,startRow=0,endRow=null}={}){
      const colCount = rows[0]?.length ?? 0;
      const rowCount = rows.length;
      const eCol = endCol == null ? (colCount ? colCount-1 : 0) : Math.min(endCol, Math.max(0,colCount-1));
      // Detectar última fila con datos si endRow es null
      let eRow = rowCount-1;
      if (endRow != null) eRow = Math.min(endRow, Math.max(0,rowCount-1));
      else {
        for (let i=rowCount-1; i>=startRow; i--) {
          if ((rows[i]||[]).some(c => String(c).trim() !== '')) { eRow = i; break; }
        }
      }
      return rows.slice(startRow, eRow+1).map(r => r.slice(startCol, eCol+1));
    }

    function makeCard(title, subtitle){
      const card=document.createElement('article'); card.className='card';
      const head=document.createElement('header'); const h2=document.createElement('h2'); h2.textContent=title;
      const small=document.createElement('small'); small.textContent=subtitle||''; head.appendChild(h2); head.appendChild(small);
      card.appendChild(head); return card;
    }

    // =============================
    // Formatos condicionales y normalizaciones (Torneo)
    // =============================
    function applyConditionalFormatting(table, cols){
      const norm = s => (s||'').toLowerCase().split(' ').join('');
      const names = cols.map(norm);
      const idxScore = names.findIndex(h => h.indexOf('score') !== -1);
      const idxWin   = names.findIndex(h => h.indexOf('winrate') !== -1);
      const idxCGan  = names.findIndex(h => h.indexOf('cambiopartidasganadas') !== -1);
      const idxCPer  = names.findIndex(h => h.indexOf('cambiopartidasperdidas') !== -1);
      const idxCPos  = names.findIndex(h => h.indexOf('cambioposición') !== -1 || h.indexOf('cambioposicion') !== -1);

      table.querySelectorAll('tbody tr').forEach(tr => {
        // Normalizar / redondear
        if (idxScore !== -1) {
          const td = tr.children[idxScore];
          const n = parseFloat(String(td.textContent).replace(',', '.'));
          if (!isNaN(n)) td.textContent = n.toFixed(2); // 2 decimales
        }
        if (idxWin !== -1) {
          const td = tr.children[idxWin];
          let n = parseFloat(String(td.textContent).replace('%','').replace(',', '.'));
          if (!isNaN(n)) {
            if (n <= 1) n = n * 100;        // si llegó 0..1 => %
            td.textContent = n.toFixed(2) + '%';
          }
        }

        // Score con límites inclusivos (≥)
        if (idxScore !== -1){
          const td = tr.children[idxScore];
          const n = parseFloat(String(td.textContent).replace(',', '.'));
          let bg=null, fg='#000';
          if (!isNaN(n)){
            if (n >= 90) bg = '#00E5FF';
            else if (n >= 80) bg = '#00E676';
            else if (n >= 70) bg = '#43A047';
            else if (n >= 60) bg = '#C5E1A5';
            else if (n >= 50) bg = '#FFF176';
            else if (n >= 40) bg = '#FFB74D';
            else if (n >= 30) bg = '#FB8C00';
            else if (n >= 20) bg = '#FF3B30';
            else if (n >= 10) { bg = '#C62828'; fg = '#FFF'; }
            else { bg = '#000000'; fg = '#FFF'; }
          }
          if (bg){ td.style.background = bg; td.style.color = fg; td.classList.add('score'); }
        }

        // Cambios (flechas y 0) — Ganadas normal / Perdidas invertido
        const paintCambio = (cell, invert=false) => {
          const t = (cell.textContent||'').trim();
          if (t === '0') { cell.style.color = '#42A5F5'; return; } // azul
          const up = t.indexOf('▲') !== -1;
          const down = t.indexOf('▼') !== -1;
          if (!invert) {
            if (up) cell.style.color = '#2E7D32';
            if (down) cell.style.color = '#C62828';
          } else {
            if (up) cell.style.color = '#C62828';
            if (down) cell.style.color = '#2E7D32';
          }
        };
        if (idxCGan !== -1) paintCambio(tr.children[idxCGan], false);  // Ganadas
        if (idxCPer !== -1) paintCambio(tr.children[idxCPer], true);   // Perdidas

        // Cambio Posición (solo clausura)
        if (idxCPos !== -1){
          const td = tr.children[idxCPos];
          const t = (td.textContent||'').trim();
          if (t === '-') td.style.color = '#42A5F5';
          else if (t.indexOf('▲') !== -1) td.style.color = '#2E7D32';
          else if (t.indexOf('▼') !== -1) td.style.color = '#C62828';
        }
      });
    }

    // =============================
    // Reglamento (B..K y M..V)
    // =============================
    async function renderReglamento(){
      view.innerHTML='';

      // Rango amplio para cubrir nuevos artículos en el futuro
      const cfg = {
        gid: "406827875",
        left:  { startCol: 1, endCol: 10, startRow: 0, endRow: 500 }, // B..K, filas 1..500
        right: { startCol: 12, endCol: 21, startRow: 0, endRow: 50 }  // M..V, filas 1..50
      };

      const card = makeCard('Reglamento', `gid: ${cfg.gid}`);
      const wrap = document.createElement('div'); wrap.className='two-col';

      // Panel izquierdo (Reglamento)
      const left = document.createElement('div'); left.className='panel';
      left.appendChild(Object.assign(document.createElement('header'),{textContent:'Reglamento'}));
      const lb=document.createElement('div'); lb.className='body'; left.appendChild(lb);

      // Panel derecho (Enmiendas)
      const right = document.createElement('div'); right.className='panel';
      right.appendChild(Object.assign(document.createElement('header'),{textContent:'Enmiendas'}));
      const rb=document.createElement('div'); rb.className='body'; right.appendChild(rb);

      card.appendChild(wrap); wrap.appendChild(left); wrap.appendChild(right); view.appendChild(card);

      try {
        const res = await fetch(gvizUrl(cfg.gid)); const txt = await res.text(); const data = parseGviz(txt);

        // ==== REGLAMENTO (B..K) ====
        const L = sliceRange(data.rows, cfg.left);
        // unir D..K (índices 2..10 relativos al rango B..K)
        const joinDK = (row) => {
          const vals = (row || []).slice(2);  // D..K dentro del rango B..K
          const first = vals.find(v => String(v||'').trim() !== '');
          return (first ?? vals.join(' ')).toString().trim();
        };

        for (let i=0;i<L.length;i++){
          const r = L[i] || [];
          const B = r[0] ? String(r[0]).trim() : '';    // índice/“Sección”/“Art.” (B)
          const C = r[1] ? String(r[1]).trim() : '';    // inciso (C)
          const txtDK = joinDK(r);                      // texto/título (D..K)

          const emptyRow = (!B && !C && !txtDK);
          if (emptyRow) {
            const spacer = document.createElement('div');
            spacer.style.height='6px';
            lb.appendChild(spacer);
            continue;
          }

          const isSeccion  = /^secci[óo]n\b/i.test(B) || /^secci[óo]n\b/i.test(C);
          const isArticulo = /^art\.?/i.test(B) || /^art\.?/i.test(C);

          if (isSeccion) {
            // Título de sección: nombre (D..K) centrado, grande y bold
            const title = document.createElement('div');
            title.className='reg-sec-title';
            title.textContent = txtDK || (B || C);
            lb.appendChild(title);
          } else if (isArticulo || txtDK) {
            // Fila de artículo (índice B/C + texto D..K en itálica)
            const row = document.createElement('div'); row.className='reg-art';
            const idx = document.createElement('div');
            const idxText = [B, C].filter(Boolean).join(' ').trim();
            idx.innerHTML = idxText ? `<strong>${idxText}</strong>` : '&nbsp;';
            const t = document.createElement('div'); t.className='t'; t.textContent = txtDK;
            row.appendChild(idx); row.appendChild(t); lb.appendChild(row);
          }
        }

        // ==== ENMIENDAS (M..V) ====
        const R = sliceRange(data.rows, cfg.right);
        if (R.length){
          // Título (fila 1 suele tener “Enmiendas”)
          const titleRow = R[0] || [];
          const titleText = titleRow.slice(0).find(v => String(v||'').trim() !== '');
          if (titleText && /enmiendas/i.test(String(titleText))) {
            const tt = document.createElement('div');
            tt.className = 'reg-sec-title';
            tt.textContent = String(titleText);
            rb.appendChild(tt);
          }
          // Enmiendas desde fila 2
          for (let i=1;i<R.length;i++){
            const r = R[i] || [];
            const M = r[0] ? String(r[0]).trim() : '';      // M
            const N = r[1] ? String(r[1]).trim() : '';      // N
            const texto = (r.slice(2).find(v => String(v||'').trim() !== '') || r.slice(2).join(' ')).toString().trim(); // O..V
            const empty = (!M && !N && !texto);
            if (empty) continue;

            const item = document.createElement('div'); item.style.padding='8px 0';
            item.innerHTML = `
              <div><strong>${[M,N].filter(Boolean).join(' ')}</strong></div>
              <div>${texto}</div>
            `;
            rb.appendChild(item);
          }
        }
      } catch (err) {
        const p=document.createElement('p'); p.className='warn'; p.textContent = `No se pudo leer el reglamento: ${err.message}`; card.appendChild(p);
      }
    }

    // =============================
    // Torneo (Apertura/Clausura)
    // =============================
    async function renderRanking(which){
      view.innerHTML='';
      const cfg = CFG[which];
      const card = makeCard(which==='apertura'?'Torneo Apertura 2025':'Torneo Clausura 2025', `gid: ${cfg.gid}`);
      view.appendChild(card);
      try{
        const res = await fetch(gvizUrl(cfg.gid)); const txt = await res.text(); const data = parseGviz(txt);
        const rows = sliceRange(data.rows, cfg.range).filter(r => r.some(c => String(c).trim() !== ''));
        let cols = data.cols.slice(cfg.range.startCol, cfg.range.endCol + 1);

        // ==== RECORTE DETERMINÍSTICO POR ENCABEZADOS ====
        const norm = (h) => (h || '').toString().trim().toLowerCase();
        const scoreIdx     = cols.findIndex(h => /(^|\s)score($|\s)/i.test(h || ''));
        const cambioPosIdx = cols.findIndex(h => /cambio.*posici/i.test(norm(h)));
        let lastKeep = scoreIdx;                                   // Apertura: hasta Score
        if (which === 'clausura' && cambioPosIdx !== -1)           // Clausura: hasta Cambio Posición si existe
          lastKeep = Math.max(scoreIdx, cambioPosIdx);
        const useIdx = (lastKeep >= 0)
          ? Array.from({ length: lastKeep + 1 }, (_, i) => i)
          : Array.from({ length: cols.length }, (_, i) => i);

        cols = useIdx.map(i => cols[i]);
        const prunedRows = rows.map(r => useIdx.map(i => r[i]));

        // ==== TABLA ====
        const table=document.createElement('table');
        const thead=document.createElement('thead'); const trh=document.createElement('tr');
        cols.forEach(h=>{const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);});
        thead.appendChild(trh); table.appendChild(thead);

        const tbody=document.createElement('tbody');
        prunedRows.forEach(r=>{
          const tr=document.createElement('tr');
          for(let i=0;i<cols.length;i++){
            const td=document.createElement('td'); td.textContent = r[i] ?? ''; tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
        table.appendChild(tbody); card.appendChild(table);

        // Formatos / redondeos / colores
        applyConditionalFormatting(table, cols);
      }catch(err){
        const p=document.createElement('p'); p.className='warn'; p.textContent = `No se pudo leer el torneo: ${err.message}`; card.appendChild(p);
      }
    }

    // =============================
    // Events
    // =============================
    btnReglamento.addEventListener('click', () => renderReglamento());
    btnTorneo.addEventListener('click', () => renderRanking(selTorneo.value));
    selTorneo.addEventListener('change', () => renderRanking(selTorneo.value));
    btnActualizar.addEventListener('click', () => {
      const active = view.querySelector('.card h2')?.textContent || '';
      if (/Reglamento/.test(active)) renderReglamento();
      else renderRanking(selTorneo.value);
    });

    // Vista inicial
    renderReglamento();
  </script>
</body>
</html>
