<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo Taruga ‚Äì Tablas limpias (GViz)</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#8aa0c8; --border:#22314f; --accent:#4cc9f0; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Ubuntu,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 16px;text-align:center;border-bottom:1px solid var(--border)}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
    header p{margin:0;color:var(--muted)}
    main{max-width:1200px;margin:0 auto;padding:20px}
    .controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:18px}
    input[type="search"]{background:#0e172a;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;min-width:280px}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width: 980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.18)}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card h2{margin:0;font-size:18px}
    .card small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:center}
    th{position:sticky;top:0;background:#0e172a;font-weight:700;cursor:pointer}
    tr:nth-child(even) td{background:#0f1a31}
    .hidden{display:none}
    .footer{padding:20px;text-align:center;color:var(--muted)}
    .warn{padding:12px 16px;color:#ffd7d7}
    .warn a{color:#ffd7d7;text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <h1>Tabla del Torneo Taruga</h1>
    <p>Tablas limpias con Google Visualization API (GViz). Debe estar compartido como ‚ÄúCualquiera con el enlace ‚Äì Lector‚Äù.</p>
  </header>
  <main>
    <div class="controls">
      <input id="search" type="search" placeholder="Buscar en las tablas‚Ä¶" />
      <button class="btn" id="refresh">Actualizar datos</button>
    </div>

    <section id="cards" class="grid"></section>

    <div class="footer">Hecho para Renzo ‚Ä¢ GitHub Pages ‚Ä¢ <span id="updated"></span></div>
  </main>

  <script>
    // =============================
    // üöß CONFIGURACI√ìN ‚Äì EDITA AQU√ç
    // =============================
    // ID del documento (entre /d/ y /edit en la URL del Google Sheet original)
    const SHEET_ID = "1_fruD9zPdXhiWcP_wuuryIFHmxLQBlYHDM9CyY0_1s4";

    // Lista de hojas a mostrar (solo las que quieras). Usa sus gid.
    const SHEETS = [
      { title: "Reglamento", gid: "406827875" },
      { title: "Torneo Apertura 2025", gid: "888277887" },
      { title: "Torneo Clausura 2025", gid: "62379087" }
    ];

    // =============================
    // ‚öôÔ∏è Utilidades
    // =============================
    const cardsEl = document.getElementById('cards');
    const updatedEl = document.getElementById('updated');
    const searchEl = document.getElementById('search');

    function gvizUrl(gid){
      // out:json => respuesta como JS envuelto en JSON
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
    }

    // Parseador del JSON envuelto que devuelve GViz
    function parseGviz(text){
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) throw new Error('Respuesta GViz inv√°lida');
      const json = JSON.parse(text.slice(start, end + 1));
      if (json.status && json.status !== 'ok') {
        const det = json.errors && json.errors[0] ? `${json.errors[0].message}: ${json.errors[0].detailed_message || ''}` : 'Error GViz';
        throw new Error(det);
      }
      const cols = (json.table.cols || []).map(c => c.label || c.id || "");
      const rows = (json.table.rows || []).map(r => (r.c || []).map(c => (c ? c.v : "")));
      return { cols, rows };
    }

    function toTable({cols, rows}){
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      cols.forEach((h, idx) => {
        const th = document.createElement('th');
        th.textContent = h;
        th.addEventListener('click', () => sortBy(table, idx));
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        if(r.every(cell => String(cell).trim() === '')) return; // omite filas vac√≠as
        const tr = document.createElement('tr');
        r.forEach(c => {
          const td = document.createElement('td');
          td.textContent = c;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      return table;
    }

    function sortBy(table, colIndex){
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const current = table.getAttribute('data-sort-col') == colIndex ? table.getAttribute('data-sort-dir') : null;
      const dir = current === 'asc' ? 'desc' : 'asc';
      rows.sort((a,b) => {
        const av = a.children[colIndex].textContent;
        const bv = b.children[colIndex].textContent;
        const an = parseFloat(av.replace(/,/g, '.'));
        const bn = parseFloat(bv.replace(/,/g, '.'));
        const aIsNum = !isNaN(an) && av.trim() !== '';
        const bIsNum = !isNaN(bn) && bv.trim() !== '';
        if(aIsNum && bIsNum){ return dir === 'asc' ? an - bn : bn - an; }
        return dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      });
      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
      table.setAttribute('data-sort-col', colIndex);
      table.setAttribute('data-sort-dir', dir);
    }

    function filterTables(term){
      const cards = Array.from(document.querySelectorAll('.card'));
      cards.forEach(card => {
        const table = card.querySelector('table');
        if(!table){ card.classList.remove('hidden'); return; }
        const hay = Array.from(table.querySelectorAll('tbody tr')).some(tr =>
          Array.from(tr.children).some(td => td.textContent.toLowerCase().includes(term))
        );
        card.classList.toggle('hidden', !hay);
      });
    }

    async function loadOne({title, gid}){
      const card = document.createElement('article');
      card.className = 'card';
      const head = document.createElement('header');
      const h2 = document.createElement('h2');
      h2.textContent = title;
      const small = document.createElement('small');
      small.textContent = `gid: ${gid}`;
      head.appendChild(h2);
      head.appendChild(small);
      card.appendChild(head);

      try {
        const url = gvizUrl(gid) + `&cacheBust=${Date.now()}`; // evita cach√©
        const res = await fetch(url, { cache: 'no-store' });
        const txt = await res.text();
        const data = parseGviz(txt);
        card.appendChild(toTable(data));
      } catch (err) {
        const p = document.createElement('p');
        p.className = 'warn';
        p.innerHTML = `No se pudo leer esta hoja. <br><b>Posible causa:</b> permisos. <br>
          Asegurate en el Google Sheet original de: <br>
          ‚Ä¢ Compartir ‚Üí <b>Cualquier persona con el enlace ‚Äì Lector</b>, o <br>
          ‚Ä¢ Archivo ‚Üí Compartir ‚Üí <b>Publicar en la web</b> (la hoja).<br><br>
          Error: ${err.message}`;
        card.appendChild(p);
      }

      return card;
    }

    async function loadAll(){
      cardsEl.innerHTML = '';
      const parts = await Promise.allSettled(SHEETS.map(loadOne));
      let ok = 0;
      parts.forEach(p => { if(p.status === 'fulfilled'){ ok++; cardsEl.appendChild(p.value); } });
      updatedEl.textContent = ok ? `√öltima actualizaci√≥n: ${new Date().toLocaleString()}` : 'Sin datos';
    }

    document.getElementById('refresh').addEventListener('click', loadAll);
    searchEl.addEventListener('input', (e)=> filterTables(e.target.value.toLowerCase()));

    // Arranque
    loadAll();
  </script>
</body>
</html>
